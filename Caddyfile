ant.safemedia.com {

# Show 'safebox server' on root /

    respond / "safebox server test"

    # Proxy WebSocket traffic separately
    reverse_proxy /ws* app:8081

    # Proxy /anttp/* to app:18888, strip /anttp prefix when sending
    handle_path /anttp/* {
        rewrite * {path}
        reverse_proxy app:18888 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Port {server_port}
            header_up X-Forwarded-Proto {scheme}

            # Rewrite Location headers from backend redirects to add /anttp prefix back
            handle_response {
                @redirect header Location ^/
                header Location add_prefix /anttp
            }

            # Optionally, rewrite links inside HTML body (harder, requires sub_filter or similar)
        }
    }

    # Do NOT forward any other paths (e.g., /91d16e58... or others)
    # They will fall through and get 404 by default


    log {
        output stdout
    }

}
